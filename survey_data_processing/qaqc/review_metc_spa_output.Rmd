---
title: "MetCouncil SPA Output Review"
author: "Leah Flake"
output: 
  html_document:
    collapsed: yes
    toc: yes
    toc_depth: 4
    toc_float: yes
    self_contained: true
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
library(data.table)
library(kableExtra)
library(dplyr)
source('_functions.R')
library(yaml)
settings = yaml.load_file('E:/Projects/Clients/MetCouncilASIM/tasks/survey_data_processing/metc_inputs.yml')

spa_output_dir = settings$SPA_output_dir
spa_input_dir = settings$SPA_input_dir

survey_hh = fread(file.path(spa_input_dir, "HH_SPA_INPUT.csv"))
survey_per = fread(file.path(spa_input_dir, "PER_SPA_INPUT.csv"))
# survey_place = fread(file.path(spa_input_dir, "PLACE_SPA_INPUT.csv"))
survey_place = data.table()
spa_trip = data.table()
spa_tour = data.table()
spa_hh = data.table()
spa_per = data.table()

for(dow in c(1:4)){
  cat(dow)
  place_data = fread(file.path(spa_input_dir, paste0('place_', as.character(dow), ".csv")))
  
  survey_place = rbindlist(list(survey_place, place_data), use.names = TRUE, fill = TRUE)
  
  trip_data = fread(file.path(spa_output_dir,  paste0('day', as.character(dow)), "trips.csv"))
  trip_data[, dow_num := dow]

  spa_trip = rbindlist(list(spa_trip, trip_data), use.names = TRUE, fill = TRUE)
  
  tour_data = fread(file.path(spa_output_dir,  paste0('day', as.character(dow)), "tours.csv"))
  tour_data[, dow_num := dow]

  spa_tour = rbindlist(list(spa_tour, tour_data), use.names = TRUE, fill = TRUE)

}

spa_hh = fread(file.path(spa_output_dir,  'day1', "households.csv"))

spa_per = fread(file.path(spa_output_dir,  'day1', "persons.csv"))
# join weights - fix in SPA tool
spa_trip[survey_place, HHEXPFACT := TRIP_WEIGHT, on= .(HH_ID = SAMPN, PER_ID = PERNO, DEST_PLACENO = PLANO, dow_num = DOW)]

spa_trip[survey_place, HHEXPFACT := ifelse(is.na(HHEXPFACT), i.TRIP_WEIGHT, HHEXPFACT), on= .(HH_ID = SAMPN, PER_ID = PERNO, ORIG_PLACENO = PLANO, dow_num = DOW)]

spa_trip[, PEREXPFACT :=  HHEXPFACT]
spa_per[survey_per, PEREXPFACT :=  i.PEREXPFAC, on = .(HH_ID = SAMPN, PER_ID = PERNO)]
spa_tour[spa_trip, PEREXPFACT :=  i.PEREXPFACT, on = .(HH_ID, PER_ID, TOUR_ID, dow_num)]
spa_tour[spa_trip, HHEXPFACT :=  i.HHEXPFACT, on = .(HH_ID, PER_ID, TOUR_ID, dow_num)]
spa_hh[survey_hh, HHEXPFACT :=  i.HHEXPFAC, on = .(HH_ID = SAMPN)]

# label data

dpurp_value_labels = data.table(variable = rep('DEST_PURP', 14), value = c(0:13), value_label =  c('HOME' , 
                                                                          'WORK'  ,
                                                                          'UNIVERSITY',   
                                                                          'SCHOOL',       
                                                                          'ESCORTING',    
                                                                          'SHOPPING',     
                                                                          'MAINTENANCE',  
                                                                          'EAT OUT',      
                                                                          'SOCIAL/VISIT', 
                                                                          'DISCRETIONARY',
                                                                          'WORK-RELATED', 
                                                                          'LOOP',         
                                                                          'CHANGE MODE',  
                                                                          'OTHER'))

dpurp_variable_labels = data.table(variable = 'DEST_PURP', description = 'Trip dest purpose', logic = NA)


tourpurp_variable_labels = data.table(variable = 'TOURPURP', description = 'Tour purpose', logic = NA)


tourpurp_value_labels = data.table(variable = rep('TOURPURP', 14), value = c(0:13), value_label =  c('HOME' , 
                                                                          'WORK'  ,
                                                                          'UNIVERSITY',   
                                                                          'SCHOOL',       
                                                                          'ESCORTING',    
                                                                          'SHOPPING',     
                                                                          'MAINTENANCE',  
                                                                          'EAT OUT',      
                                                                          'SOCIAL/VISIT', 
                                                                          'DISCRETIONARY',
                                                                          'WORK-RELATED', 
                                                                          'LOOP',         
                                                                          'CHANGE MODE',  
                                                                          'OTHER'))



tripmode_value_labels = data.table(variable = rep('TRIPMODE', 19), value = c(1:19), value_label = c('SOV',
                                                                                                    'HOV2',
                                                                                                    'HOV3',
                                                                                                    'WALK',
                                                                                                    'BIKE',
                                                                                                    'WALK-LOCAL',
                                                                                                    'WALK-PREMIUM',
                                                                                                    'WALK-MIXED',
                                                                                                    'PNR-LOCAL',
                                                                                                    'PNR-PREMIUM',
                                                                                                    'PNR-MIXED',
                                                                                                    'KNR-LOCAL',
                                                                                                    'KNR-PREMIUM',
                                                                                                    'KNR-MIXED',
                                                                                                    'TNC-SINGLE',
                                                                                                    'TNC-SHARED',
                                                                                                    'TAXI',
                                                                                                    'SCHOOLBUS', 
                                                                                                    'OTHER'))


tripmode_variable_labels = data.table(variable = 'TRIPMODE', description = 'Trip mode', logic = NA)

tourmode_value_labels = data.table(variable = rep('TOURMODE', 19), value = c(1:19), value_label = c('SOV',
                                                                                                    'HOV2',
                                                                                                    'HOV3',
                                                                                                    'WALK',
                                                                                                    'BIKE',
                                                                                                    'WALK-LOCAL',
                                                                                                    'WALK-PREMIUM',
                                                                                                    'WALK-MIXED',
                                                                                                    'PNR-LOCAL',
                                                                                                    'PNR-PREMIUM',
                                                                                                    'PNR-MIXED',
                                                                                                    'KNR-LOCAL',
                                                                                                    'KNR-PREMIUM',
                                                                                                    'KNR-MIXED',
                                                                                                    'TNC-SINGLE',
                                                                                                    'TNC-SHARED',
                                                                                                    'TAXI',
                                                                                                    'SCHOOLBUS', 
                                                                                                    'OTHER'))

# tourmode_value_labels[, value_label := paste(value, '-', value_label)]
# tripmode_value_labels[, value_label := paste(value, '-', value_label)]
# dpurp_value_labels[, value_label := paste(value, '-', value_label)]
# tourpurp_value_labels[, value_label := paste(value, '-', value_label)]

tourmode_variable_labels = data.table(variable = 'TOURMODE', description = 'Tour mode', logic = NA)


ptype_value_labels = data.table(variable = rep('PERSONTYPE', 8), value = c(1:8), value_label = c('FT worker',
                                                                                                 'PT worker', 
                                                                                                 'University student',
                                                                                                 'Non-working adult',
                                                                                                 'Retiree',
                                                                                                 'Driving age student',
                                                                                                 'Non-driving age student',
                                                                                                 'Preschooler'))

ptype_variable_labels = data.table(variable = 'PERSONTYPE', description = 'Person type', logic = NA)

age_value_labels = data.table(variable = rep('AGE', 10), value = c(1:10), value_label = c('Under 5',
                                                                                        '5-15', 
                                                                                        '16-17',
                                                                                        '18-24',
                                                                                        '25-34',
                                                                                        '35-44',
                                                                                        '45-54',
                                                                                        '55-64',
                                                                                        '65-74',
                                                                                        '75+'))

age_variable_labels = data.table(variable = 'AGE', description = 'Person age', logic = NA)

value_labels = rbindlist(list(tripmode_value_labels, tourmode_value_labels, tourpurp_value_labels, dpurp_value_labels, ptype_value_labels, age_value_labels))

variable_labels = rbindlist(list(tripmode_variable_labels, tourmode_variable_labels, tourpurp_variable_labels, dpurp_variable_labels, ptype_variable_labels, age_variable_labels))

```


```{r create_summaries, eval=TRUE, echo=FALSE, message=FALSE, warning=FALSE, include = FALSE}

trip_purpose_tab_w = cross_tab(spa_trip, variable_labels ,value_labels, variables = 'DEST_PURP', weight_column = "PEREXPFACT")

format_crosstab_table(trip_purpose_tab_w)

trip_purpose_tab_uw = cross_tab(spa_trip, variable_labels ,value_labels, variables = 'DEST_PURP')
format_crosstab_table(trip_purpose_tab_uw)


tour_purpose_tab_w = cross_tab(spa_tour, variable_labels ,value_labels, variables = 'TOURPURP', weight_column = "PEREXPFACT")
format_crosstab_table(tour_purpose_tab_w)

tour_purpose_tab_uw = cross_tab(spa_tour, variable_labels ,value_labels, variables = 'TOURPURP')
format_crosstab_table(tour_purpose_tab_uw)


trip_tour_mode_tab_w = cross_tab(spa_trip, variable_labels ,value_labels, variables = 'TRIPMODE', tab_by = 'TOURMODE', weight_column = "PEREXPFACT")
format_crosstab_table(trip_tour_mode_tab_w)

trip_tour_mode_tab_w[is.na(trip_tour_mode_tab_w)] = ""
trip_tour_mode_tab_w_count = trip_tour_mode_tab_w[, c(1:18)]
setcolorder(trip_tour_mode_tab_w_count, c('TRIPMODE', "1 - SOV", "2 - HOV2", "3 - HOV3","4 - WALK", "5 - BIKE", "6 - WALK-LOCAL", "7 - WALK-PREMIUM" , "8 - WALK-MIXED",  "9 - PNR-LOCAL" , "10 - PNR-PREMIUM", "11 - PNR-MIXED", "12 - KNR-LOCAL" ,  "13 - KNR-PREMIUM", "14 - KNR-MIXED", "16 - TNC-SHARED", '18 - SCHOOLBUS', "19 - OTHER"))

trip_tour_mode_tab_w_pct = trip_tour_mode_tab_w[, c(1, 19:35)]
setcolorder(trip_tour_mode_tab_w_pct,  c('TRIPMODE', "1 - SOV", "2 - HOV2", "3 - HOV3","4 - WALK", "5 - BIKE", "6 - WALK-LOCAL", "7 - WALK-PREMIUM" , "8 - WALK-MIXED",  "9 - PNR-LOCAL" , "10 - PNR-PREMIUM", "11 - PNR-MIXED", "12 - KNR-LOCAL" ,  "13 - KNR-PREMIUM", "14 - KNR-MIXED", "16 - TNC-SHARED", '18 - SCHOOLBUS', "19 - OTHER"))

trip_tour_mode_tab_uw = cross_tab(spa_trip, variable_labels, value_labels, variables = 'TRIPMODE', tab_by = 'TOURMODE')
format_crosstab_table(trip_tour_mode_tab_uw)
trip_tour_mode_tab_uw[is.na(trip_tour_mode_tab_uw)] = ""

trip_tour_mode_tab_uw_count = trip_tour_mode_tab_uw[, c(1:18)]
setcolorder(trip_tour_mode_tab_uw_count,  c('TRIPMODE', "1 - SOV", "2 - HOV2", "3 - HOV3","4 - WALK", "5 - BIKE", "6 - WALK-LOCAL", "7 - WALK-PREMIUM" , "8 - WALK-MIXED",  "9 - PNR-LOCAL" , "10 - PNR-PREMIUM", "11 - PNR-MIXED", "12 - KNR-LOCAL" ,  "13 - KNR-PREMIUM", "14 - KNR-MIXED", "16 - TNC-SHARED", '18 - SCHOOLBUS', "19 - OTHER"))

trip_tour_mode_tab_uw_pct = trip_tour_mode_tab_uw[, c(1, 19:35)]
setcolorder(trip_tour_mode_tab_uw_pct,c('TRIPMODE', "1 - SOV", "2 - HOV2", "3 - HOV3","4 - WALK", "5 - BIKE", "6 - WALK-LOCAL", "7 - WALK-PREMIUM" , "8 - WALK-MIXED",  "9 - PNR-LOCAL" , "10 - PNR-PREMIUM", "11 - PNR-MIXED", "12 - KNR-LOCAL" ,  "13 - KNR-PREMIUM", "14 - KNR-MIXED", "16 - TNC-SHARED", '18 - SCHOOLBUS', "19 - OTHER"))


trip_mode_tab_w = cross_tab(spa_trip, variable_labels ,value_labels, variables = 'TRIPMODE', weight_column = "PEREXPFACT")
format_crosstab_table(trip_mode_tab_w)


trip_mode_tab_uw = cross_tab(spa_trip, variable_labels ,value_labels, variables = 'TRIPMODE')
format_crosstab_table(trip_mode_tab_uw)


tour_mode_tab_w = cross_tab(spa_tour, variable_labels ,value_labels, variables = 'TOURMODE', weight_column = "PEREXPFACT")
format_crosstab_table(tour_mode_tab_w)

tour_mode_tab_uw = cross_tab(spa_tour, variable_labels ,value_labels, variables = 'TOURMODE')
format_crosstab_table(tour_mode_tab_uw)


ptype_tab_w = cross_tab(spa_per, variable_labels ,value_labels, variables = 'PERSONTYPE', weight_column = "PEREXPFACT")
format_crosstab_table(ptype_tab_w)


ptype_tab_uw = cross_tab(spa_per, variable_labels ,value_labels, variables = 'PERSONTYPE')
format_crosstab_table(ptype_tab_uw)


ptype_age_tab_w = cross_tab(spa_per, variable_labels ,value_labels, variables = 'PERSONTYPE', tab_by = 'AGE', weight_column = "PEREXPFACT")
format_crosstab_table(ptype_age_tab_w)

ptype_age_tab_uw = cross_tab(spa_per, variable_labels ,value_labels, variables = 'PERSONTYPE', tab_by = 'AGE')
format_crosstab_table(ptype_age_tab_uw)



```

## Trip and tour rate

#### Person trip rate - weighted: `r spa_trip[, sum(PEREXPFACT)]/spa_per[, sum(PEREXPFACT)]`

#### Person trip rate - unweighted: `r spa_trip[, .N]/spa_per[, .N]`


#### Person tour rate - weighted: `r spa_tour[, sum(PEREXPFACT)]/spa_per[, sum(PEREXPFACT)]`

#### Person tour rate - unweighted: `r spa_tour[, .N]/spa_per[, .N]`


#### HH trip rate - weighted: `r spa_trip[, sum(HHEXPFACT)]/spa_hh[, sum(HHEXPFACT)]`

#### HH trip rate - unweighted: `r spa_trip[, .N]/spa_hh[, .N]`


#### HH tour rate - weighted: `r spa_tour[, sum(HHEXPFACT)]/spa_hh[, sum(HHEXPFACT)]`

#### HH tour rate - unweighted: `r spa_tour[, .N]/spa_hh[, .N]`


## Weighted

```{r print_summaries, eval=TRUE, echo = FALSE, warning = FALSE, message=FALSE, results = 'asis'}

cat('\n####  Trips by purpose\n')

tpurp = format_table(trip_purpose_tab_w)
print(tpurp)

cat('\n####  Tours by purpose\n')

topurp = format_table(tour_purpose_tab_w)
print(topurp)

cat('\n####  Trips by mode\n')

format_table(trip_mode_tab_w)

cat('\n####  Tours by mode\n')

format_table(tour_mode_tab_w)

cat('\n#### Trips by trip mode x tour mode - count\n')

format_table(trip_tour_mode_tab_w_count)

cat('\n####  Trips by trip mode x tour mode - percent\n')

format_table(trip_tour_mode_tab_w_pct)


cat('\n####  Persons by type\n')

format_table(ptype_tab_w)

cat('\n####  Persons by type x age\n')

format_table(ptype_age_tab_w)
```


## Unweighted

```{r print_summaries_uw, eval=TRUE, echo = FALSE, warning = FALSE, message=FALSE, results = 'asis'}

cat('\n####  Trips by purpose\n')

tpurp = format_table(trip_purpose_tab_uw)
print(tpurp)

cat('\n#### Tours by purpose\n')

topurp = format_table(tour_purpose_tab_uw)
print(topurp)

cat('\n#### Trips by mode\n')

format_table(trip_mode_tab_uw)

cat('\n#### Tours by mode\n')

format_table(tour_mode_tab_uw)

cat('\n#### Trips by trip mode x tour mode - count\n')

format_table(trip_tour_mode_tab_uw_count)

cat('\n#### Trips by trip mode x tour mode - percent\n')

format_table(trip_tour_mode_tab_uw_pct)


cat('\n#### Persons by type\n')

format_table(ptype_tab_uw)

cat('\n#### Persons by type x age\n')

format_table(ptype_age_tab_uw)
```


```{r change_mode, include = FALSE, echo = FALSE}


```
